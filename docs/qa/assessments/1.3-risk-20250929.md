# Risk Profile: Story 1.3 - Setup Wizard Implementation

**Date**: 2025-09-29
**Reviewer**: Quinn (Test Architect)
**Story**: 1.3 - Setup Wizard Implementation

---

## Executive Summary

- **Total Risks Identified**: 14
- **Critical Risks (Score 9)**: 3
- **High Risks (Score 6)**: 4
- **Medium Risks (Score 4)**: 4
- **Low Risks (Score 2-3)**: 3
- **Overall Risk Score**: 29/100 (High Risk - Requires Significant Mitigation)

### Risk Score Calculation

```
Base Score: 100
Critical (3 Ã— 20): -60
High (4 Ã— 10): -40
Medium (4 Ã— 5): -20
Low (3 Ã— 2): -6
---
Final Score: 29/100
```

**Interpretation**: This story carries **HIGH RISK** due to multiple critical issues around state management, security, and rollback reliability. Significant mitigation required before production deployment.

---

## Critical Risks Requiring Immediate Attention

### 1. TECH-001: Interactive CLI State Management Complexity

**Score: 9 (Critical)**
**Category**: Technical
**Probability**: High (3) - Complex coordination between Ink rendering, Zustand state, and async operations (detection, generation, validation)
**Impact**: High (3) - Wizard crash or hang blocks user completely; corrupted state leads to incorrect configs

**Detailed Analysis**:
The wizard coordinates:

- Ink terminal UI rendering (synchronous React-like lifecycle)
- Zustand state management (async updates)
- Multi-step navigation with back/forward
- Long-running async operations (detection engine, file I/O, validation)
- User input handling with validation

Race conditions can occur when:

- User navigates quickly through steps before async operations complete
- Detection results arrive after user has moved to next step
- Validation runs while user is modifying inputs
- Rollback triggered during active file writes

**Affected Components**:

- `wizard-container.tsx` - Main orchestration
- `wizard-service.ts` - Business logic
- Zustand stores - State management
- All wizard step components

**Mitigation Strategies**:

1. **Preventive Actions**:
   - Implement state machine for wizard flow (prevent invalid transitions)
   - Use semaphores/locks for async operation coordination
   - Disable navigation buttons during async operations
   - Add operation queue to serialize critical file operations
   - Implement comprehensive error boundaries in Ink components

2. **Testing Requirements**:
   - **Unit Tests**: State machine transitions (50+ test cases for all paths)
   - **Integration Tests**: Rapid navigation stress test (spam back/forward buttons)
   - **Chaos Tests**: Interrupt async operations at random points
   - **Load Tests**: Simulate slow file system (network mount) during wizard
   - **Error Tests**: Trigger failures at each async operation point

3. **Code Review Focus**:
   - Zustand state update patterns (avoid race conditions)
   - Ink `useEffect` cleanup functions (prevent memory leaks)
   - Async/await error handling completeness
   - State consistency validation after each step

**Residual Risk**: Medium - Even with mitigations, edge cases in Ink + Zustand interaction may remain
**Owner**: Dev Team
**Timeline**: Must fix before any user testing
**Gate Impact**: FAIL if unmitigated

---

### 2. SEC-001: Configuration File Injection via User Input

**Score: 9 (Critical)**
**Category**: Security
**Probability**: High (3) - Wizard accepts user paths, custom rule names, and config values
**Impact**: High (3) - Arbitrary code execution when ESLint/Prettier/TypeScript configs are evaluated

**Detailed Analysis**:
Configuration files for ESLint (`.eslintrc.js`, `eslint.config.js`) and Prettier (`.prettierrc.js`) are executable JavaScript. If wizard generates these files using unsanitized user input, an attacker could inject malicious code:

**Attack Scenarios**:

1. **ESLint Config Injection**:
   - User provides custom rule name: `require('child_process').exec('rm -rf /')`
   - Generated config: `module.exports = { rules: { require('child_process').exec('rm -rf /') } }`
   - Executes when ESLint runs

2. **Path Traversal + Injection**:
   - User provides project path: `../../../etc/`
   - Wizard writes malicious config to system directory

3. **TypeScript Config Path Mapping**:
   - User provides alias: `@evil": "../../../node_modules/evil-package`
   - TypeScript resolves malicious package

**Affected Components**:

- `config-generator.ts` - All tool config generators
- ESLint config writer
- Prettier config writer
- TypeScript config writer
- Project path handling throughout wizard

**Mitigation Strategies**:

1. **Preventive Actions**:
   - **Input Sanitization**: Whitelist allowed characters for all user inputs
     - Rule names: `[a-zA-Z0-9-_/]` only
     - Paths: Resolve to absolute, validate within project bounds
     - Config values: JSON-only (no JS evaluation)
   - **Prefer JSON Configs**: Generate `.eslintrc.json`, `.prettierrc.json` (no code execution)
   - **Path Validation**: Use `path.resolve()` and check `startsWith(projectPath)`
   - **Template-Based Generation**: Use predefined templates, no string interpolation of user input
   - **Escape User Values**: If user input must appear in configs, escape properly

2. **Testing Requirements**:
   - **Security Tests**: OWASP injection test vectors (20+ cases)
   - **Fuzzing**: Random input generation to find edge cases
   - **Path Traversal Tests**: `../../`, symlinks, absolute paths
   - **Code Execution Tests**: Verify no eval() or require() of user input
   - **Manual Penetration Test**: Security review of all input handling

3. **Code Review Checklist**:
   - [ ] All user inputs pass through validation function
   - [ ] No `eval()`, `Function()`, or `require()` of user-provided strings
   - [ ] Paths resolved to absolute and validated within bounds
   - [ ] Config templates use parameterized values, not concatenation
   - [ ] Generated configs reviewed for injection vulnerabilities

**Residual Risk**: Low - JSON-based configs eliminate code execution risk
**Owner**: Dev Team (Security Review Required)
**Timeline**: MUST FIX before any release
**Gate Impact**: FAIL if unmitigated

---

### 3. OPS-001: Rollback Failure Leaves System in Inconsistent State

**Score: 9 (Critical)**
**Category**: Operational
**Probability**: High (3) - Multiple file operations with potential mid-transaction failures
**Impact**: High (3) - User's project configs corrupted, unable to restore working state

**Detailed Analysis**:
The wizard promises "atomic rollback (all or nothing)" but file system operations are not transactional by nature. Failure scenarios:

**Failure Scenarios**:

1. **Partial Backup Failure**:
   - Backup of `eslint.config.js` succeeds
   - Backup of `tsconfig.json` fails (permission denied)
   - Wizard proceeds, generates new configs
   - Rollback restores eslint but not tsconfig â†’ inconsistent state

2. **Partial Restore Failure**:
   - User cancels wizard
   - Rollback starts: restores `bunfig.toml` successfully
   - Rollback fails to restore `.prettierrc.json` (disk full)
   - User left with mix of old and new configs

3. **Rollback During Active Write**:
   - Config generation in progress
   - User hits Ctrl+C
   - Rollback attempts to restore while file is being written
   - File corruption

4. **Backup Cleanup Failure**:
   - Wizard completes successfully
   - Cleanup tries to delete backup directory
   - Permission error or file lock prevents deletion
   - Backups accumulate over time

**Affected Components**:

- `rollback.ts` - Rollback orchestration
- `config-generator.ts` - File write operations
- `wizard-service.ts` - Transaction coordination
- Backup metadata storage

**Mitigation Strategies**:

1. **Preventive Actions**:
   - **Two-Phase Commit**:
     - Phase 1: Generate all configs to temporary directory
     - Phase 2: Validate all configs
     - Phase 3: Atomic move (rename) from temp to final location
   - **Backup Validation**: Verify backup integrity before proceeding
   - **Pre-Flight Checks**: Validate disk space, permissions before starting
   - **Operation Locking**: Use file locks during writes to prevent concurrent access
   - **Idempotent Operations**: Ensure rollback can be run multiple times safely
   - **Rollback Testing**: Verify backup restoration before deleting originals

2. **Testing Requirements**:
   - **Chaos Engineering**: Kill wizard process at random points, verify rollback
   - **Disk Space Tests**: Fill disk during wizard, verify graceful failure + rollback
   - **Permission Tests**: Remove write permissions mid-wizard, verify rollback
   - **Concurrent Access Tests**: Run wizard twice simultaneously, verify isolation
   - **Partial Failure Tests**: Mock file operations to fail at each step

3. **Implementation Pattern**:

```typescript
interface RollbackTransaction {
  id: string;
  timestamp: Date;
  operations: FileOperation[];
  status: 'pending' | 'committed' | 'rolled-back';
}

async function atomicConfigUpdate(operations: FileOperation[]): Promise<void> {
  const transaction = createTransaction(operations);
  const tempDir = await createTempDirectory();

  try {
    // Phase 1: Backup
    await backupExistingConfigs(transaction, tempDir);
    await validateBackups(transaction);

    // Phase 2: Generate to temp
    await generateConfigsToTemp(operations, tempDir);
    await validateGeneratedConfigs(tempDir);

    // Phase 3: Atomic commit
    await atomicMove(tempDir, projectPath);
    transaction.status = 'committed';
  } catch (error) {
    // Rollback
    await restoreFromBackup(transaction);
    transaction.status = 'rolled-back';
    throw error;
  } finally {
    if (transaction.status === 'committed') {
      await cleanupBackups(transaction);
    }
  }
}
```

**Residual Risk**: Medium - File system operations always have edge cases (power loss, disk failure)
**Owner**: Dev Team
**Timeline**: MUST FIX before beta release
**Gate Impact**: FAIL if unmitigated

---

## High Risks (Score 6)

### 4. TECH-002: Detection Engine Timeout on Large Projects

**Score: 6 (High)**
**Probability**: Medium (2)
**Impact**: High (3)

**Description**: Detection engine may hang on projects with 1000+ files or network-mounted file systems

**Mitigation**:

- Add configurable timeout (default 30s) to detection engine call
- Show progress indicator during detection ("Scanning project files...")
- Provide manual override option if detection times out
- Test with large monorepo fixtures (5000+ files)

**Testing**: Load test with synthetic large projects, network mount simulation

---

### 5. DATA-001: SQLite Write Failure Loses Configuration

**Score: 6 (High)**
**Probability**: Medium (2)
**Impact**: High (3)

**Description**: Final SQLite persistence failure means user loses all wizard work

**Mitigation**:

- Retry SQLite writes up to 3 times with exponential backoff
- Write configuration to `.devquality.json` as backup before SQLite
- Validate SQLite write immediately after, offer file-based fallback
- Add "Export Configuration" option to save wizard results manually

**Testing**: Simulate database locks, permission errors, disk full scenarios

---

### 6. PERF-001: Parallel Validation Overwhelms System Resources

**Score: 6 (High)**
**Probability**: Medium (2)
**Impact**: Medium (2) â†’ Upgraded to High due to UX impact

**Description**: Running ESLint + Prettier + TypeScript + Bun test simultaneously consumes excessive CPU/memory

**Mitigation**:

- Implement semaphore with max concurrency limit (2 parallel validations)
- Use `Promise.allSettled()` with resource monitoring
- Add validation timeout per tool (60s each)
- Show progress indicator with current validation step

**Testing**: Resource monitoring during validation, simulate low-memory environment

---

### 7. SEC-002: Path Traversal in Configuration File Detection

**Score: 6 (High)**
**Probability**: Medium (2)
**Impact**: High (3)

**Description**: Unvalidated project path could allow reading/writing files outside project directory

**Mitigation**:

- Resolve all paths to absolute using `path.resolve()`
- Validate all operations stay within `projectPath` bounds
- Use `path.relative()` and check it doesn't start with `..`
- Reject symlinks pointing outside project directory

**Testing**: Path traversal test suite (OWASP vectors), symlink boundary tests

---

## Medium Risks (Score 4)

### 8. TECH-003: TypeScript Config Merge Logic Breaks Existing Setup

- **Mitigation**: Preserve all user settings, only add missing DevQuality defaults; test with complex extends chains
- **Testing**: Fixture tests with various tsconfig patterns (extends, paths, multiple configs)

### 9. DATA-002: Backup Files Not Cleaned Up After Success

- **Mitigation**: Add cleanup to finally block, verify cleanup in success tests
- **Testing**: Check file system state after wizard completion

### 10. PERF-002: Wizard UI Blocks on Async Operations

- **Mitigation**: Add loading spinners, disable navigation during operations, show elapsed time
- **Testing**: User experience tests with simulated slow operations

### 11. BUS-001: Generated Configs Don't Match User's Code Style

- **Mitigation**: Detect existing patterns (tabs vs spaces, quote style), offer config preview before applying
- **Testing**: User acceptance testing with diverse codebases

---

## Low Risks (Score 2-3)

### 12. OPS-002: Insufficient Error Messages for Validation Failures (Score 2)

- **Mitigation**: Include tool output in error messages, link to troubleshooting docs

### 13. DATA-003: Detection Cache Stale After File System Changes (Score 2)

- **Mitigation**: Document that wizard should be run in stable environment, add cache invalidation option

### 14. TECH-004: Monorepo Detection Incomplete (Score 3)

- **Mitigation**: Leverage Story 1.2 structure detection, test with Yarn/PNPM/Nx workspaces

---

## Risk Distribution

### By Category

- **Security**: 2 risks (1 critical, 1 high)
- **Technical**: 4 risks (1 critical, 1 high, 1 medium, 1 low)
- **Operational**: 2 risks (1 critical, 1 low)
- **Performance**: 2 risks (1 high, 1 medium)
- **Data**: 3 risks (1 high, 2 medium)
- **Business**: 1 risk (1 medium)

### By Component

- **Wizard UI (Ink)**: 2 risks (1 critical, 1 medium)
- **Config Generators**: 3 risks (1 critical, 2 medium)
- **Validation System**: 2 risks (1 high, 1 low)
- **Rollback System**: 2 risks (1 critical, 1 medium)
- **Detection Integration**: 2 risks (1 high, 1 low)
- **SQLite Persistence**: 1 risk (1 high)
- **Security (Input Handling)**: 2 risks (1 critical, 1 high)

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass Before Release)

#### TECH-001: State Management Tests

```typescript
describe('Wizard State Management', () => {
  it('prevents navigation during async operations', async () => {
    // User cannot click next while detection is running
  });

  it('handles rapid navigation without state corruption', async () => {
    // Spam back/forward buttons, verify state consistency
  });

  it('recovers from async operation failures', async () => {
    // Mock detection failure, verify wizard doesn't crash
  });

  it('handles Ctrl+C gracefully with rollback', async () => {
    // Send SIGINT at various points, verify cleanup
  });
});
```

#### SEC-001: Security Tests

```typescript
describe('Configuration Injection Prevention', () => {
  const injectionVectors = [
    "require('child_process').exec('rm -rf /')",
    "'; DROP TABLE users; --",
    '../../../etc/passwd',
    '__proto__.isAdmin',
  ];

  injectionVectors.forEach(vector => {
    it(`blocks injection: ${vector}`, async () => {
      const result = await generateConfig({ customRule: vector });
      expect(result).not.toContain('require');
      expect(result).not.toContain('child_process');
    });
  });
});
```

#### OPS-001: Rollback Tests

```typescript
describe('Atomic Rollback', () => {
  it('restores all configs if any write fails', async () => {
    // Mock partial failure, verify complete restoration
  });

  it('handles rollback during active writes', async () => {
    // Trigger rollback mid-write, verify no corruption
  });

  it('is idempotent (can run multiple times)', async () => {
    // Run rollback twice, verify same result
  });
});
```

### Priority 2: High Risk Tests

- Detection timeout tests (simulate 30s+ detection time)
- SQLite write failure and retry logic
- Parallel validation resource monitoring
- Path traversal prevention (OWASP test vectors)

### Priority 3: Medium/Low Risk Tests

- Config merge logic with various existing configs
- Backup cleanup verification
- UI loading indicators
- Error message clarity
- Cache invalidation

---

## Risk Acceptance Criteria

### Must Fix Before Production (Gate = FAIL)

- **TECH-001**: State management stability (100% test coverage, no race conditions)
- **SEC-001**: All injection vectors blocked (security review passed)
- **OPS-001**: Rollback proven reliable (chaos tests passed)

### Can Deploy with Mitigation (Gate = CONCERNS)

- **TECH-002**: Detection timeout with manual override option
- **DATA-001**: SQLite retry + file-based fallback
- **PERF-001**: Validation concurrency limit implemented
- **SEC-002**: Path validation on all file operations

### Acceptable with Monitoring (Gate = PASS with notes)

- **TECH-003**: Config merge tested with common patterns
- **PERF-002**: Loading indicators present
- **BUS-001**: Config preview option available

### Low Risk (No gate impact)

- **OPS-002**, **DATA-003**, **TECH-004**: Document limitations, monitor in production

---

## Monitoring Requirements

### Post-Deployment Metrics

**Critical Monitoring (Alerts)**:

- Wizard crash rate (target: <0.1%)
- Rollback invocation rate (target: <5%)
- Config injection attempts (target: 0, alert on any)
- SQLite write failures (target: <1%)

**Performance Monitoring**:

- Average wizard completion time (target: <2 minutes)
- Detection phase duration (target: <30s)
- Validation phase duration (target: <60s)
- Memory usage during wizard (target: <100MB)

**Business Metrics**:

- Wizard completion rate (target: >90%)
- User satisfaction with generated configs (survey)
- Manual config override rate (indicates generation quality)

---

## Risk Review Triggers

Update this risk profile when:

- New Ink or Zustand version introduces breaking changes
- Detection engine is modified (Story 1.2 changes)
- New configuration tools are added to wizard
- Security vulnerability discovered in dependencies
- User reports wizard crash or data loss
- Performance degrades below targets

---

## Recommendations

### Immediate Actions (Before Implementation)

1. **Design State Machine**: Formal state diagram for wizard flow
2. **Security Review**: Input sanitization library selection (e.g., validator.js)
3. **Rollback Strategy**: Two-phase commit design document
4. **Test Plan**: Comprehensive test suite design (estimated 150+ tests)

### Development Phase

1. **Incremental Implementation**: Build rollback first, then wizard on top
2. **Security-First**: Implement input validation before any config generation
3. **Testing Cadence**: Run security and chaos tests daily during development

### Pre-Release

1. **External Security Audit**: Third-party review of injection prevention
2. **Load Testing**: Test with real-world large projects (5000+ files)
3. **User Acceptance Testing**: Beta test with diverse project types

### Post-Release

1. **Gradual Rollout**: Feature flag wizard, enable for 10% â†’ 50% â†’ 100%
2. **Monitoring Dashboard**: Real-time wizard health metrics
3. **Incident Response Plan**: Rollback procedure if critical bugs found

---

## Quality Gate Recommendation

**Preliminary Gate Decision**: **FAIL** (Cannot pass with current risk profile)

**Justification**:

- 3 Critical risks (score 9) are unmitigated
- Security risk (SEC-001) is showstopper for any release
- Operational risk (OPS-001) could cause data loss
- Technical risk (TECH-001) threatens core functionality

**Path to PASS**:

1. Implement all Critical risk mitigations
2. Achieve 100% test coverage on security and rollback
3. Pass external security review
4. Demonstrate state management stability in chaos tests

**Estimated Effort to Mitigate Critical Risks**: 3-5 weeks of focused development + testing

---

## Appendix: Detailed Risk Register

| Risk ID  | Title                                   | Category    | Prob | Impact | Score | Priority | Owner | Status      |
| -------- | --------------------------------------- | ----------- | ---- | ------ | ----- | -------- | ----- | ----------- |
| TECH-001 | Interactive CLI State Management        | Technical   | 3    | 3      | 9     | Critical | Dev   | Unmitigated |
| SEC-001  | Configuration File Injection            | Security    | 3    | 3      | 9     | Critical | Dev   | Unmitigated |
| OPS-001  | Rollback Failure Inconsistent State     | Operational | 3    | 3      | 9     | Critical | Dev   | Unmitigated |
| TECH-002 | Detection Engine Timeout                | Technical   | 2    | 3      | 6     | High     | Dev   | Unmitigated |
| DATA-001 | SQLite Write Failure                    | Data        | 2    | 3      | 6     | High     | Dev   | Unmitigated |
| PERF-001 | Parallel Validation Resource Exhaustion | Performance | 2    | 3      | 6     | High     | Dev   | Unmitigated |
| SEC-002  | Path Traversal in File Operations       | Security    | 2    | 3      | 6     | High     | Dev   | Unmitigated |
| TECH-003 | TypeScript Config Merge Breaks Build    | Technical   | 2    | 2      | 4     | Medium   | Dev   | Unmitigated |
| DATA-002 | Backup Files Not Cleaned Up             | Data        | 2    | 2      | 4     | Medium   | Dev   | Unmitigated |
| PERF-002 | Wizard UI Blocks on Async               | Performance | 2    | 2      | 4     | Medium   | Dev   | Unmitigated |
| BUS-001  | Generated Configs Don't Match Style     | Business    | 2    | 2      | 4     | Medium   | Dev   | Unmitigated |
| OPS-002  | Insufficient Error Messages             | Operational | 1    | 2      | 2     | Low      | Dev   | Unmitigated |
| DATA-003 | Detection Cache Stale                   | Data        | 1    | 2      | 2     | Low      | Dev   | Unmitigated |
| TECH-004 | Monorepo Detection Incomplete           | Technical   | 1    | 3      | 3     | Low      | Dev   | Unmitigated |

**Total Risks**: 14
**Risk Score**: 29/100 (High Risk)

---

**Report Generated**: 2025-09-29
**Next Review**: After Critical mitigations implemented
**Reviewer**: Quinn (Test Architect) ðŸ§ª
